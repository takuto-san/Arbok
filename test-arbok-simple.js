// Simple integration test
import { arbokInit, arbokGetFileStructure, arbokSearchSymbol, arbokSetupRules } from './dist/mcp/tools.js';
import fs from 'fs';
import path from 'path';

const testProjectPath = '/tmp/arbok-test-project';

async function test() {
  console.log('=== Testing arbok_init ===');
  try {
    const initResult = await arbokInit({ projectPath: testProjectPath });
    console.log('Init result:', initResult);
  } catch (err) {
    console.error('Init failed:', err.message);
  }
  
  // Give it a moment for file operations
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  console.log('\n=== Checking .clinerules creation ===');
  const clineruleDir = path.join(testProjectPath, '.clinerules');
  if (fs.existsSync(clineruleDir)) {
    console.log('.clinerules directory created ✓');
    const rulesFile = path.join(clineruleDir, 'rules.md');
    if (fs.existsSync(rulesFile)) {
      console.log('rules.md exists ✓');
      const content = fs.readFileSync(rulesFile, 'utf-8');
      console.log('Sample:', content.substring(0, 200));
    }
    const workflowsDir = path.join(clineruleDir, 'workflows');
    if (fs.existsSync(workflowsDir)) {
      console.log('workflows directory exists ✓');
      const files = fs.readdirSync(workflowsDir);
      console.log('Workflow files:', files);
    }
  } else {
    console.log('❌ .clinerules directory NOT created');
  }
  
  console.log('\n=== Checking Memory Bank files ===');
  const memoryBankDir = path.join(testProjectPath, 'memory-bank');
  if (fs.existsSync(memoryBankDir)) {
    console.log('memory-bank directory created ✓');
    const files = fs.readdirSync(memoryBankDir);
    console.log('Memory Bank files:', files);
    console.log('Expected 6 files, got:', files.length);
    
    // Check for specific files
    const expectedFiles = [
      'productContext.md',
      'activeContext.md', 
      'progress.md',
      'systemPatterns.md',
      'techContext.md',
      'project-structure.md'
    ];
    
    for (const file of expectedFiles) {
      const filePath = path.join(memoryBankDir, file);
      if (fs.existsSync(filePath)) {
        const content = fs.readFileSync(filePath, 'utf-8');
        const lines = content.split('\n').length;
        console.log(`  ✓ ${file} (${lines} lines)`);
        
        // Check for timestamp footer
        if (content.includes('Generated by Arbok')) {
          console.log(`    - Has timestamp footer ✓`);
        }
      } else {
        console.log(`  ❌ ${file} missing`);
      }
    }
  } else {
    console.log('❌ memory-bank directory NOT created');
  }
  
  console.log('\n=== Testing arbok_get_file_structure ===');
  try {
    const fileStructResult = arbokGetFileStructure({ filePath: 'test.ts' });
    const parsed = JSON.parse(fileStructResult);
    console.log('File structure:', parsed);
    if (parsed.symbols && parsed.symbols.length > 0) {
      console.log(`✓ Found ${parsed.symbols.length} symbols`);
    }
  } catch (err) {
    console.error('Get file structure failed:', err.message);
  }
  
  console.log('\n=== Testing arbok_search_symbol ===');
  try {
    const searchResult = arbokSearchSymbol({ query: 'hello' });
    const parsed = JSON.parse(searchResult);
    console.log('Search result:', parsed);
    if (parsed.results && parsed.results.length > 0) {
      console.log(`✓ Found ${parsed.results.length} matches`);
    }
  } catch (err) {
    console.error('Search failed:', err.message);
  }
  
  console.log('\n✅ All tests completed!');
  process.exit(0);
}

test().catch(err => {
  console.error('Test failed:', err);
  process.exit(1);
});
